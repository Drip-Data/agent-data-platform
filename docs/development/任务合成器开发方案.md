# 🎯 Synthesis模块架构设计方案

## 📋 项目概述

Synthesis模块是Agent Data Platform的智能任务合成器，负责从执行轨迹中提取任务本质并存储到数据库中。该模块采用完全容器化架构，与现有系统形成完整的数据处理闭环。

## 🏗️ 系统架构

### 整体架构
```
Agent Data Platform
├── 🔄 数据输入层
│   ├── 用户种子任务
│   ├── 轨迹文件收集
│   └── 高质量轨迹回流
│
├── 🧬 Synthesis模块 (容器化)
│   ├── HTTP API (端口8081)
│   ├── Redis Worker  
│   ├── LLM轨迹分析
│   └── SQLite数据库
│
├── 🏃 执行环境 (现有)
│   ├── Dispatcher
│   ├── Sandbox Runtime
│   └── Web Navigator
│
└── 📊 数据输出层
    ├── 任务本质数据库
    ├── 生成任务队列
    └── 执行轨迹收集
```

### 数据流设计
```
轨迹文件 → Synthesis分析 → 任务本质存储 → 未来任务生成
    ↑                                              ↓
    └──────── 新轨迹产生 ←── 任务执行 ←── 生成任务队列
```

## 🔧 核心组件

### 1. 轨迹分析引擎 (synthesis.py)
**功能**：
- 接收轨迹JSON文件
- 调用LLM API分析轨迹内容  
- 提取任务本质（task_type, domain, description等）
- 存储到SQLite数据库

**技术实现**：
- LLM客户端：支持Gemini、DeepSeek、OpenAI
- 异步处理：Redis队列管理
- 数据持久化：SQLite本地存储
- 防重复：轨迹文件处理状态跟踪

### 2. HTTP API接口 (synthesis_api.py)
**功能**：
- 提供REST API控制接口
- 健康检查和状态监控
- 数据库CRUD操作
- 轨迹处理触发

**端点设计**：
```
GET  /health          # 健康检查
POST /trigger/full     # 处理所有轨迹
POST /trigger/new      # 处理新轨迹
GET  /db/tasks        # 获取任务数据
GET  /db/stats        # 数据库统计
```

### 3. 统一管理界面
**Docker管理器**：
- 容器生命周期管理
- 镜像构建和部署
- 日志查看和故障排除

**服务管理器**：
- API调用封装
- 数据查看和导出
- 健康检查和监控

## 📊 数据结构设计

### 输入：轨迹数据 (TrajectoryResult)
```json
{
  "task_id": "fibonacci_10",
  "success": true,
  "steps": [
    {
      "step_id": 1,
      "action_type": "code_generation",
      "observation": "def fibonacci(n)...",
      "success": true
    }
  ],
  "final_result": "The 10th Fibonacci number is: 55",
  "total_duration": 2.19
}
```

### 输出：任务本质 (TaskEssence)
```json
{
  "id": "essence_001",
  "task_type": "code",
  "tool_category": "algorithm", 
  "description": "计算第N个斐波那契数",
  "created_at": "2024-01-15T10:30:00Z"
}
```

## 🚀 部署架构

### 容器化部署
```yaml
# docker-compose.synthesis.yml
services:
  synthesis:
    build: .
    ports:
      - "8081:8081"
    volumes:
      - ./output:/app/output
  environment:
      - SYNTHESIS_ENABLED=true
    - GEMINI_API_KEY=${GEMINI_API_KEY}
  
    redis:
    image: redis:7-alpine
  ports:
      - "6379:6379"
```

### 统一管理命令
```bash
# 部署管理
python core/synthesiscore/docker_manager.py deploy
python core/synthesiscore/docker_manager.py status

# 功能管理  
python core/synthesiscore/synthesis_manager.py health
python core/synthesiscore/synthesis_manager.py tasks
```

## 🔬 技术特点

### 1. 完全容器化
- ✅ 环境隔离和一致性
- ✅ 跨平台部署支持
- ✅ 简化的依赖管理
- ✅ 标准化的运维流程

### 2. API驱动架构
- ✅ 松耦合组件设计
- ✅ 标准HTTP接口
- ✅ 易于测试和调试
- ✅ 支持水平扩展

### 3. 智能轨迹分析
- ✅ 多LLM支持和切换
- ✅ 结构化数据提取
- ✅ 自动分类和标记
- ✅ 增量处理能力

### 4. 统一管理体验
- ✅ 单命令部署
- ✅ 集中监控和日志
- ✅ 自动化健康检查
- ✅ 简化的故障排除

## 📈 扩展方向

### 近期扩展
1. **任务生成器**：基于本质数据生成新任务
2. **质量评估**：轨迹和任务的质量评分
3. **多样性优化**：确保生成任务的多样性

### 长期规划
1. **智能推荐**：基于历史数据的任务推荐
2. **自动优化**：根据执行结果自动调整生成策略
3. **分布式处理**：支持大规模轨迹数据处理

## 🎯 核心价值

### 数据资产积累
- 持续从轨迹中提取高质量任务本质
- 建立结构化的任务知识库
- 支持任务模式的发现和复用

### 自动化流程
- 减少人工任务设计工作量
- 提高任务生成的效率和质量
- 实现数据驱动的任务优化

### 系统可维护性
- 标准化的部署和管理流程
- 清晰的组件边界和职责
- 完善的监控和诊断工具

---

这个架构设计实现了轨迹数据的智能分析和任务本质的自动提取，为Agent数据平台提供了持续的数据价值创造能力。 