# 文档：实现层级化工具调用的日志记录与交互验证

## 1. 目标

本次修改旨在解决两个核心问题：

1.  **确保嵌套的、层级化的工具调用（服务+动作）被完整地记录在最终的 XML 轨迹中**，以生成高质量的训练数据。
2.  **增加详细的日志**，使动态、分层的工具选择交互过程完全透明化，便于调试和验证。

## 2. 详细修改步骤

### 步骤 2.1: [日志记录] 重构执行器以记录嵌套 XML

-   **文件**: `core/streaming/sequential_executor.py`
-   **目的**: 在 `_execute_single_tool` 方法中，当通过二次调用确定了具体 `action` 后，需要将这个决策过程“物化”为嵌套的 XML 字符串，并更新到执行步骤中，以便最终能被正确记录。

-   **修改逻辑**: 
    1.  在 `_execute_single_tool` 方法中，当通过 `_request_action_selection` 成功获取到 `action` 和 `parameters` 后：
    2.  **重新构建 `step.content`**: 根据获取到的 `action` 和 `parameters`，生成一个嵌套的 XML 字符串。例如，`f"<{action}>{parameters['instruction']}</{action}>"`。
    3.  **更新 `step.content`**: 用这个新生成的、包含嵌套标签的字符串，去**覆盖**原始 `step` 对象中的 `content`。
    4.  这样，当这个 `step` 被传递给 `ResultInjector` 或最终的日志记录模块时，它包含的就是我们期望的、完整的嵌套结构。

### 步骤 2.2: [交互验证] 为分层选择过程添加详细日志

-   **文件**: `core/streaming/sequential_executor.py`
-   **目的**: 在 `_request_action_selection` 方法中增加日志，使整个二级决策过程透明化。

-   **新增日志点**: 
    1.  在方法开始时，记录日志：`logger.debug(f"为服务 '{tool_id}' 请求二级动作选择，原始指令: '{instruction}'")`。
    2.  获取到 `actions_description` 后，记录日志：`logger.debug(f"从 Schema 获取到 '{tool_id}' 的可用动作:\n{actions_description}")`。
    3.  在调用 LLM 之前，记录完整的二次选择 Prompt：`logger.debug(f"发送给 LLM 的二级选择 Prompt:\n{prompt}")`。
    4.  在收到 LLM 响应后，记录其原始选择：`logger.debug(f"LLM 返回的二级选择结果: {response.strip()}")`。

## 3. 预期成果

1.  **高质量数据**: 最终生成的 XML 轨迹将包含完整的、类似 `<microsandbox><execute_code>...</execute_code></microsandbox>` 的嵌套结构，完美地体现了 Agent 的层级化思考过程。
2.  **高透明度**: 通过查看日志，我们可以清晰地看到每一次为 MCP Server 选择具体 Action 时的完整交互过程，包括 Agent 看到了哪些选项、以及它最终做出了什么选择，极大地便利了系统的调试与优化。

