version: '3.8'

# ====================================================================
# 任务合成器扩展模块 - 独立部署配置
# 本文件为原agent-data-platform项目的扩展模块
# 可以独立部署，也可以与原系统集成
# ====================================================================

services:
  # =================================================================
  # Redis服务 - 数据存储和队列
  # =================================================================
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - agent-data-platform
    restart: unless-stopped

  # =================================================================
  # 模块1: 智能任务合成器 (轨迹分析与任务生成)
  # =================================================================
  
  # 任务合成器 - 模块1核心智能组件
  synthesis:
    build: .
    environment:
      - REDIS_URL=redis://redis:6379
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # 合成器配置
      - SYNTHESIS_ENABLED=true
      - SYNTHESIS_DB=${SYNTHESIS_DB:-/app/output/synthesis.db}
      # LLM API配置 (统一接口)
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_API_URL=${GEMINI_API_URL}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - DEEPSEEK_API_URL=${DEEPSEEK_API_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_API_BASE=${OPENAI_API_BASE}
      - API_PORT=8081
      - API_HOST=0.0.0.0
    ports:
      - "8081:8081"
    depends_on:
      - redis
    volumes:
      - ./output:/app/output
      - ./core:/app/core
    restart: unless-stopped
    command: >
      sh -c "
      echo '🚀 Starting synthesis services...' &&
      echo '📝 Initializing database...' &&
      python -m core.synthesiscore.init_synthesis_db &&
      echo '🔄 Starting synthesis worker and API...' &&
      python -m core.synthesiscore.synthesis > /tmp/synthesis_worker.log 2>&1 &
      echo 'Worker started with PID:' $! &&
      sleep 2 &&
      echo 'Starting API server...' &&
      python -m core.synthesiscore.synthesis_api
      "
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
    networks:
      - agent-data-platform
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  agent-data-platform:
    external: true

volumes:
  synthesis_data:
  redis_data: 