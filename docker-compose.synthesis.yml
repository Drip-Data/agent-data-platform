version: '3.8'

# ====================================================================
# ä»»åŠ¡åˆæˆå™¨æ‰©å±•æ¨¡å— - ç‹¬ç«‹éƒ¨ç½²é…ç½®
# æœ¬æ–‡ä»¶ä¸ºåŽŸagent-data-platformé¡¹ç›®çš„æ‰©å±•æ¨¡å—
# å¯ä»¥ç‹¬ç«‹éƒ¨ç½²ï¼Œä¹Ÿå¯ä»¥ä¸ŽåŽŸç³»ç»Ÿé›†æˆ
# ====================================================================

services:
  # =================================================================
  # RedisæœåŠ¡ - æ•°æ®å­˜å‚¨å’Œé˜Ÿåˆ—
  # =================================================================
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - agent-data-platform
    restart: unless-stopped

  # =================================================================
  # æ¨¡å—1: æ™ºèƒ½ä»»åŠ¡åˆæˆå™¨ (è½¨è¿¹åˆ†æžä¸Žä»»åŠ¡ç”Ÿæˆ)
  # =================================================================
  
  # ä»»åŠ¡åˆæˆå™¨ - æ¨¡å—1æ ¸å¿ƒæ™ºèƒ½ç»„ä»¶
  synthesis:
    build: .
    environment:
      - REDIS_URL=redis://redis:6379
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # åˆæˆå™¨é…ç½®
      - SYNTHESIS_ENABLED=true
      - SYNTHESIS_DB=${SYNTHESIS_DB:-/app/output/synthesis.db}
      # LLM APIé…ç½® (ç»Ÿä¸€æŽ¥å£)
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_API_URL=${GEMINI_API_URL}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - DEEPSEEK_API_URL=${DEEPSEEK_API_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_API_BASE=${OPENAI_API_BASE}
      - API_PORT=8081
      - API_HOST=0.0.0.0
    ports:
      - "8081:8081"
    depends_on:
      - redis
    volumes:
      - ./output:/app/output
      - ./core:/app/core
    restart: unless-stopped
    command: >
      sh -c "
      echo 'ðŸš€ Starting synthesis services...' &&
      echo 'ðŸ“ Initializing database...' &&
      python -m core.synthesiscore.init_synthesis_db &&
      echo 'ðŸ”„ Starting synthesis worker and API...' &&
      python -m core.synthesiscore.synthesis > /tmp/synthesis_worker.log 2>&1 &
      echo 'Worker started with PID:' $! &&
      sleep 2 &&
      echo 'Starting API server...' &&
      python -m core.synthesiscore.synthesis_api
      "
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
    networks:
      - agent-data-platform
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  agent-data-platform:
    external: true

volumes:
  synthesis_data:
  redis_data: 