version: '3.8'

# ====================================================================
# 任务合成器扩展模块 - 基于JSON文件存储的独立部署配置
# 本文件为原agent-data-platform项目的扩展模块
# 可以独立部署，也可以与原系统集成
# 完全移除数据库依赖，使用JSON文件存储
# ====================================================================

services:
  # =================================================================
  # Redis服务 - 数据存储和队列
  # =================================================================
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: >
      redis-server 
      --appendonly yes 
      --maxmemory 4gb 
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    restart: unless-stopped
    networks:
      - agent_network

  # =================================================================
  # 模块1: 智能任务合成器 (轨迹分析与任务生成) - JSON文件存储版本
  # =================================================================
  
  # 任务合成器 - 模块1核心智能组件
  synthesis:
    build: .
    environment:
      - REDIS_URL=redis://redis:6379
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # 合成器配置 - 基于JSON文件存储
      - SYNTHESIS_ENABLED=true
      # 自动化功能配置
      - AUTO_MONITOR_TRAJECTORIES=${AUTO_MONITOR_TRAJECTORIES:-true}
      - AUTO_EXPORT_SEEDS=${AUTO_EXPORT_SEEDS:-true}
      # LLM API配置 (统一接口)
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_API_URL=${GEMINI_API_URL}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - DEEPSEEK_API_URL=${DEEPSEEK_API_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_API_BASE=${OPENAI_API_BASE}
    depends_on:
      redis:
        condition: service_healthy
    volumes:
      - ./output:/app/output
      - ./core:/app/core
      - ./start_synthesis.py:/app/start_synthesis.py
    restart: unless-stopped
    command: python /app/start_synthesis.py
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
    networks:
      - agent_network

networks:
  agent_network:
    driver: bridge

volumes:
  redis_data: 