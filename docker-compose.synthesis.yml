version: '3.8'

# ====================================================================
# ä»»åŠ¡åˆæˆå™¨æ‰©å±•æ¨¡å— - ç‹¬ç«‹éƒ¨ç½²é…ç½®
# æœ¬æ–‡ä»¶ä¸ºåŽŸagent-data-platformé¡¹ç›®çš„æ‰©å±•æ¨¡å—
# å¯ä»¥ç‹¬ç«‹éƒ¨ç½²ï¼Œä¹Ÿå¯ä»¥ä¸ŽåŽŸç³»ç»Ÿé›†æˆ
# ====================================================================

services:
  # =================================================================
  # RedisæœåŠ¡ - æ•°æ®å­˜å‚¨å’Œé˜Ÿåˆ—
  # =================================================================
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - agent-data-platform
    restart: unless-stopped

  # =================================================================
  # æ¨¡å—1: æ™ºèƒ½ä»»åŠ¡åˆæˆå™¨ (è½¨è¿¹åˆ†æžä¸Žä»»åŠ¡ç”Ÿæˆ)
  # =================================================================
  
  # ä»»åŠ¡åˆæˆå™¨ - æ¨¡å—1æ ¸å¿ƒæ™ºèƒ½ç»„ä»¶
  synthesis:
    build: .
    environment:
      - REDIS_URL=redis://redis:6379
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      # åˆæˆå™¨é…ç½®
      - SYNTHESIS_ENABLED=${SYNTHESIS_ENABLED:-false}
      - SYNTHESIS_DB=${SYNTHESIS_DB:-/app/output/synthesis.db}
      # LLM APIé…ç½® (ç»Ÿä¸€æŽ¥å£)
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_API_URL=${GEMINI_API_URL}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - DEEPSEEK_API_URL=${DEEPSEEK_API_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_API_BASE=${OPENAI_API_BASE}
    depends_on:
      - redis
    volumes:
      - ./output:/app/output
      - ./core:/app/core
    restart: unless-stopped
    command: >
      sh -c "
      echo 'ðŸ”§ Starting synthesis service initialization...' &&
      python -m core.synthesiscore.cli.init_db &&
      echo 'âœ… Database pre-initialization completed' &&
      echo 'ðŸš€ Starting synthesis plugin...' &&
      python -m core.synthesiscore.synthesis_plugin
      "
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
    networks:
      - agent-data-platform
    healthcheck:
      test: ["CMD", "python", "-c", "import sqlite3; conn = sqlite3.connect('/app/output/synthesis.db'); conn.execute('SELECT 1 FROM task_essences LIMIT 1'); conn.close()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  agent-data-platform:
    external: true

volumes:
  synthesis_data:
  redis_data: 