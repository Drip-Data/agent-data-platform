#!/usr/bin/env python3
"""
LLMå®¢æˆ·ç«¯ç»Ÿä¸€æ¥å£
æ”¯æŒå¤šç§APIæä¾›å•†ï¼švLLMæœ¬åœ°æœåŠ¡ã€OpenAIã€Google Geminiã€DeepSeekç­‰
"""

import os
import json
import logging
from typing import Dict, Any, Optional, List
from enum import Enum
import httpx
import asyncio

logger = logging.getLogger(__name__)

class LLMProvider(Enum):
    """LLMæä¾›å•†æšä¸¾"""
    VLLM = "vllm"
    OPENAI = "openai"
    GEMINI = "gemini"
    DEEPSEEK = "deepseek"

class LLMClient:
    """ç»Ÿä¸€çš„LLMå®¢æˆ·ç«¯"""
    
    def __init__(self, config: Dict[str, Any]):
        self.config = config
        # ä¼˜å…ˆä½¿ç”¨é…ç½®ä¸­æŒ‡å®šçš„æä¾›å•†ï¼Œæ²¡æœ‰åˆ™è¿›è¡Œè‡ªåŠ¨æ£€æµ‹
        if 'provider' in config:
            provider_name = config['provider'].lower()
            if provider_name == 'vllm':
                self.provider = LLMProvider.VLLM
            elif provider_name == 'openai':
                self.provider = LLMProvider.OPENAI
            elif provider_name == 'gemini':
                self.provider = LLMProvider.GEMINI
            elif provider_name == 'deepseek':
                self.provider = LLMProvider.DEEPSEEK
            else:
                logger.warning(f"Unknown provider in config: {provider_name}, falling back to auto-detection")
                self.provider = self._detect_provider()
        else:
            self.provider = self._detect_provider()
            
        self.client = httpx.AsyncClient(timeout=60.0)
        
        logger.info(f"Initialized LLM client with provider: {self.provider.value}")
    
    def _detect_provider(self) -> LLMProvider:
        """è‡ªåŠ¨æ£€æµ‹ä½¿ç”¨çš„LLMæä¾›å•†"""
        # ä¼˜å…ˆçº§ï¼šGemini > DeepSeek > OpenAI > vLLM
        if os.getenv('GEMINI_API_KEY'):
            return LLMProvider.GEMINI
        elif os.getenv('DEEPSEEK_API_KEY'):
            return LLMProvider.DEEPSEEK
        elif os.getenv('OPENAI_API_KEY'):
            return LLMProvider.OPENAI
        else:
            return LLMProvider.VLLM
    
    async def generate_code(self, description: str, language: str = "python") -> Dict[str, str]:
        """ç”Ÿæˆä»£ç ï¼Œå¹¶è¿”å›æ€è€ƒè¿‡ç¨‹å’Œä»£ç """
        disable_cache = os.getenv("DISABLE_CACHE") or self.config.get("disable_cache", False)
        logger.debug(f"LLMClient.generate_code called: disable_cache={disable_cache}, description={description[:50]}")
        prompt = self._build_code_prompt(description, language)
        
        try:
            response = await self._call_api(prompt)
            code = self._extract_code(response, language)
            # ä¿å­˜åŸå§‹æ€è€ƒè¿‡ç¨‹
            thinking = response
            if len(thinking) > 2000:  # å¦‚æœæ€è€ƒè¿‡ç¨‹å¤ªé•¿ï¼Œæˆªå–å‰åéƒ¨åˆ†
                thinking = thinking[:1000] + "\n... (å†…å®¹è¿‡é•¿ï¼Œå·²æˆªæ–­) ...\n" + thinking[-1000:]
            
            return {
                "code": code,
                "thinking": thinking,
                "success": True
            }
        except Exception as e:
            logger.error(f"Failed to generate code: {e}")
            # ä¸å†ä½¿ç”¨å¤‡ç”¨æ¨¡æ¿ï¼Œè€Œæ˜¯ç›´æ¥æŠ¥å‘Šé”™è¯¯
            raise RuntimeError(f"æ— æ³•ç”Ÿæˆä»£ç : {e}") from e
    
    async def generate_web_actions(self, description: str, page_content: str = "") -> List[Dict]:
        """ç”ŸæˆWebæ“ä½œæ­¥éª¤"""
        prompt = self._build_web_prompt(description, page_content)
        
        try:
            response = await self._call_api(prompt)
            actions = self._extract_web_actions(response)
            return actions
        except Exception as e:
            logger.error(f"Failed to generate web actions: {e}")
            return self._fallback_web_actions(description)
    
    async def generate_reasoning(self, task_description: str, available_tools: List[str],
                                previous_steps: List[Dict] = None,
                                browser_context: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        """ç”Ÿæˆæ¨ç†æ­¥éª¤å’Œå·¥å…·è°ƒç”¨"""
        prompt = self._build_reasoning_prompt(task_description, available_tools, previous_steps, browser_context)
        
        try:
            response = await self._call_api(prompt)
            return self._parse_reasoning_response(response)
        except Exception as e:
            logger.error(f"Failed to generate reasoning: {e}")
            return {
                "thinking": f"Error occurred while processing: {e}",
                "action": "error",
                "tool": None,
                "parameters": {},
                "confidence": 0.0
            }
    
    async def generate_enhanced_reasoning(self, task_description: str, available_tools: List[str],
                                         tool_descriptions: str,
                                         previous_steps: List[Dict] = None,
                                         execution_context: Optional[Dict[str, Any]] = None) -> Dict[str, Any]:
        """ç”Ÿæˆå¢å¼ºæ¨ç†æ­¥éª¤å’Œå·¥å…·è°ƒç”¨ - ä½¿ç”¨ä¸°å¯Œçš„å·¥å…·æè¿°å’Œæ‰§è¡Œä¸Šä¸‹æ–‡"""
        prompt = self._build_enhanced_reasoning_prompt(
            task_description, available_tools, tool_descriptions, previous_steps, execution_context
        )
        
        try:
            response = await self._call_api(prompt)
            return self._parse_reasoning_response(response)
        except Exception as e:
            logger.error(f"Failed to generate enhanced reasoning: {e}")
            return {
                "thinking": f"Error occurred while processing: {e}",
                "action": "error",
                "tool": None,
                "parameters": {},
                "confidence": 0.0
            }
    
    async def generate_task_summary(self, task_description: str, steps: List[Dict], 
                                   final_outputs: List[str]) -> str:
        """ç”Ÿæˆä»»åŠ¡æ‰§è¡Œæ€»ç»“"""
        prompt = self._build_summary_prompt(task_description, steps, final_outputs)
        
        try:
            response = await self._call_api(prompt)
            return response.strip()
        except Exception as e:
            logger.error(f"Failed to generate summary: {e}")
            return f"Task completed with {len(steps)} steps. Final outputs: {'; '.join(final_outputs[:3])}"
    
    async def check_task_completion(self, task_description: str, steps: List[Dict], 
                                   current_outputs: List[str]) -> Dict[str, Any]:
        """æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å®Œæˆ"""
        prompt = self._build_completion_check_prompt(task_description, steps, current_outputs)
        
        try:
            response = await self._call_api(prompt)
            return self._parse_completion_response(response)
        except Exception as e:
            logger.error(f"Failed to check completion: {e}")
            return {"completed": False, "confidence": 0.0, "reason": f"Error: {e}"}

    async def _call_api(self, prompt: str) -> str:
        """è°ƒç”¨ç›¸åº”çš„API"""
        if self.provider == LLMProvider.VLLM:
            return await self._call_vllm(prompt)
        elif self.provider == LLMProvider.OPENAI:
            return await self._call_openai(prompt)
        elif self.provider == LLMProvider.GEMINI:
            return await self._call_gemini(prompt)
        elif self.provider == LLMProvider.DEEPSEEK:
            return await self._call_deepseek(prompt)
        else:
            raise ValueError(f"Unsupported provider: {self.provider}")
    
    async def _call_vllm(self, prompt: str) -> str:
        """è°ƒç”¨vLLMæœ¬åœ°æœåŠ¡"""
        vllm_url = self.config.get("vllm_url", "http://localhost:8000")
        
        payload = {
            "model": "default",
            "messages": [
                {"role": "user", "content": prompt}
            ],
            "max_tokens": 1024,
            "temperature": 0.1
        }
        
        response = await self.client.post(
            f"{vllm_url}/v1/chat/completions",
            json=payload
        )
        response.raise_for_status()
        
        result = response.json()
        return result["choices"][0]["message"]["content"]
    
    async def _call_openai(self, prompt: str) -> str:
        """è°ƒç”¨OpenAI API"""
        api_key = os.getenv('OPENAI_API_KEY')
        api_base = os.getenv('OPENAI_API_BASE', 'https://api.openai.com/v1')
        
        payload = {
            "model": "gpt-3.5-turbo",
            "messages": [
                {"role": "user", "content": prompt}
            ],
            "max_tokens": 1024,
            "temperature": 0.1
        }
        
        headers = {
            "Authorization": f"Bearer {api_key}",
            "Content-Type": "application/json"
        }
        
        response = await self.client.post(
            f"{api_base}/chat/completions",
            json=payload,
            headers=headers
        )
        response.raise_for_status()
        
        result = response.json()
        return result["choices"][0]["message"]["content"]
    
    async def _call_gemini(self, prompt: str) -> str:
        """è°ƒç”¨Google Gemini API"""
        api_key = os.getenv('GEMINI_API_KEY')
        api_url = os.getenv('GEMINI_API_URL', 'https://generativelanguage.googleapis.com/v1beta')
        
        # éªŒè¯å¹¶ä½¿ç”¨æœ‰æ•ˆçš„Geminiæ¨¡å‹åç§°
        model_name = os.getenv('GEMINI_MODEL', 'gemini-2.5-flash-preview-05-20')  # æ›´æ–°é»˜è®¤æ¨¡å‹
        valid_models = [
            'gemini-2.5-flash-preview-05-20',  # æ·»åŠ æ–°çš„é¢„è§ˆæ¨¡å‹
            'gemini-2.0-flash', 'gemini-2.0-pro', 
            'gemini-1.0-pro', 'gemini-pro'
        ]
        
        if model_name not in valid_models:
            logger.warning(f"Invalid Gemini model '{model_name}', using default 'gemini-2.5-flash-preview-05-20'")
            model_name = 'gemini-2.5-flash-preview-05-20'
        
        payload = {
            "contents": [
                {
                    "parts": [
                        {"text": prompt}
                    ]
                }
            ],
            "generationConfig": {
                "temperature": 0.1,
                "maxOutputTokens": 1024
            }
        }
        
        try:
            response = await self.client.post(
                f"{api_url}/models/{model_name}:generateContent?key={api_key}",
                json=payload
            )
            response.raise_for_status()
            
            result = response.json()
            
            # æ£€æŸ¥å“åº”æ ¼å¼
            if "candidates" not in result:
                raise ValueError(f"Invalid Gemini response format: missing 'candidates' field")
            
            if not result["candidates"]:
                raise ValueError(f"Empty candidates in Gemini response")
                
            candidate = result["candidates"][0]
            if "content" not in candidate:
                raise ValueError(f"Invalid candidate format: missing 'content' field")
                
            content = candidate["content"]
            if "parts" not in content:
                raise ValueError(f"Invalid content format: missing 'parts' field")
                
            if not content["parts"]:
                raise ValueError(f"Empty parts in content")
                
            part = content["parts"][0]
            if "text" not in part:
                raise ValueError(f"Invalid part format: missing 'text' field")
                
            return part["text"]
            
        except Exception as e:
            logger.error(f"Gemini API call failed: {e}")
            # å¦‚æœä½¿ç”¨äº†ä¸ç¨³å®šçš„æ¨¡å‹ï¼Œå°è¯•å›é€€åˆ°ç¨³å®šç‰ˆæœ¬
            if model_name != 'gemini-1.5-flash':
                logger.info("Retrying with stable model 'gemini-1.5-flash'")
                try:
                    response = await self.client.post(
                        f"{api_url}/models/gemini-1.5-flash:generateContent?key={api_key}",
                        json=payload
                    )
                    response.raise_for_status()
                    result = response.json()
                    
                    # åŒæ ·çš„æ ¼å¼æ£€æŸ¥
                    if ("candidates" in result and result["candidates"] and 
                        "content" in result["candidates"][0] and
                        "parts" in result["candidates"][0]["content"] and
                        result["candidates"][0]["content"]["parts"] and
                        "text" in result["candidates"][0]["content"]["parts"][0]):
                        return result["candidates"][0]["content"]["parts"][0]["text"]
                    else:
                        raise ValueError(f"Invalid fallback response format")
                        
                except Exception as fallback_e:
                    logger.error(f"Fallback model also failed: {fallback_e}")
                    raise e  # æŠ›å‡ºåŸå§‹é”™è¯¯
            else:
                raise
    
    async def _call_deepseek(self, prompt: str) -> str:
        """è°ƒç”¨DeepSeek API"""
        api_key = os.getenv('DEEPSEEK_API_KEY')
        api_url = os.getenv('DEEPSEEK_API_URL', 'https://api.deepseek.com/v1')
        
        payload = {
            "model": "deepseek-coder",
            "messages": [
                {"role": "user", "content": prompt}
            ],
            "max_tokens": 1024,
            "temperature": 0.1
        }
        
        headers = {
            "Authorization": f"Bearer {api_key}",
            "Content-Type": "application/json"
        }
        
        response = await self.client.post(
            f"{api_url}/chat/completions",
            json=payload,
            headers=headers
        )
        response.raise_for_status()
        
        result = response.json()
        return result["choices"][0]["message"]["content"]
    
    def _build_code_prompt(self, description: str, language: str) -> str:
        """æ„å»ºä»£ç ç”Ÿæˆæç¤ºï¼Œå¢å¼ºæ€è€ƒè¿‡ç¨‹æ•è·"""
        return f"""è¯·æ ¹æ®ä»¥ä¸‹æè¿°ç”Ÿæˆ{language}ä»£ç ã€‚

é¦–å…ˆï¼Œè¯¦ç»†æ€è€ƒå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒåŒ…æ‹¬å¯èƒ½çš„ç®—æ³•ã€æ•°æ®ç»“æ„ä»¥åŠå®ç°æ­¥éª¤ã€‚
åœ¨ä½ çš„æ€è€ƒè¿‡ç¨‹ä¸­ï¼Œåˆ†æä¸åŒçš„è§£å†³æ–¹æ¡ˆå¹¶é€‰æ‹©æœ€ä½³æ–¹æ¡ˆã€‚

æè¿°ï¼š{description}

è¦æ±‚ï¼š
1. å…ˆè¯¦ç»†æè¿°ä½ çš„æ€è€ƒè¿‡ç¨‹ï¼ŒåŒ…æ‹¬ä½ è€ƒè™‘çš„ä¸åŒæ–¹æ³•
2. ä»£ç åº”è¯¥å®Œæ•´ä¸”å¯æ‰§è¡Œ
3. åŒ…å«å¿…è¦çš„æ³¨é‡Š
4. å¤„ç†å¯èƒ½çš„å¼‚å¸¸æƒ…å†µ
5. è¾“å‡ºç»“æœåˆ°æ§åˆ¶å°

==== æ€è€ƒè¿‡ç¨‹ ====
(è¯·åœ¨è¿™é‡Œè¯¦ç»†å†™å‡ºä½ çš„æ€è€ƒè¿‡ç¨‹ï¼ŒåŒ…æ‹¬ç®—æ³•é€‰æ‹©ã€æ•°æ®ç»“æ„ã€å®ç°æ€è·¯ç­‰)

==== ä»£ç å®ç° ====
(åœ¨æ­¤å¤„ç”Ÿæˆæœ€ç»ˆä»£ç )
"""
    
    def _build_web_prompt(self, description: str, page_content: str) -> str:
        """æ„å»ºWebæ“ä½œæç¤º"""
        return f"""è¯·æ ¹æ®ä»¥ä¸‹æè¿°ç”ŸæˆWebæ“ä½œæ­¥éª¤ï¼š

ä»»åŠ¡æè¿°ï¼š{description}

å½“å‰é¡µé¢å†…å®¹ï¼š
{page_content[:1000] if page_content else 'æ— '}

è¯·è¿”å›JSONæ ¼å¼çš„æ“ä½œæ­¥éª¤åˆ—è¡¨ï¼Œæ¯ä¸ªæ­¥éª¤åŒ…å«ï¼š
- action: æ“ä½œç±»å‹ï¼ˆnavigate, click, fill, waitç­‰ï¼‰
- selector: CSSé€‰æ‹©å™¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
- value: è¾“å…¥å€¼ï¼ˆå¦‚æœéœ€è¦ï¼‰
- description: æ“ä½œæè¿°

ç¤ºä¾‹æ ¼å¼ï¼š
[
  {{"action": "navigate", "url": "https://example.com", "description": "æ‰“å¼€ç½‘ç«™"}},
  {{"action": "fill", "selector": "#search", "value": "æœç´¢å†…å®¹", "description": "å¡«å†™æœç´¢æ¡†"}},
  {{"action": "click", "selector": "button[type=submit]", "description": "ç‚¹å‡»æœç´¢æŒ‰é’®"}}
]

è¯·åªè¿”å›JSONæ•°ç»„ï¼Œä¸è¦åŒ…å«å…¶ä»–æ–‡å­—ï¼š"""
    
    def _build_reasoning_prompt(self, task_description: str, available_tools: List[str],
                                previous_steps: List[Dict] = None,
                                browser_context: Optional[Dict[str, Any]] = None) -> str:
        """æ„å»ºæ¨ç†æç¤º"""
        tool_descriptions = []
        for tool_name in available_tools:
            # å¼ºåˆ¶ä½¿ç”¨ä¸¥æ ¼çš„å·¥å…·è°ƒç”¨æ ¼å¼å’Œç¤ºä¾‹ï¼Œè¯¦è§ docs/AGENT_IMPROVEMENT_PLAN.md
            logger.debug("æ„å»ºæ¨ç†æç¤ºï¼šåº”ç”¨ä¸¥æ ¼çš„å·¥å…·ä½¿ç”¨è§„åˆ™å’Œç¤ºä¾‹")
            if tool_name == 'browser':
                browser_desc = (
                    f"- browser: ç”¨äºä¸ç½‘é¡µäº¤äº’çš„å·¥å…·ã€‚æ”¯æŒä»¥ä¸‹ä¸»è¦ ACTION:\n"
                    f"    - `browser_navigate`: å¯¼èˆªåˆ°æŒ‡å®šURLã€‚PARAMETERS: `{{ \"url\": \"<å®Œæ•´çš„HTTP/HTTPS URL>\" }}`\n"
                    f"    - `browser_get_text`: æå–é¡µé¢æ–‡æœ¬ã€‚PARAMETERS: `{{ \"selector\": \"<CSSé€‰æ‹©å™¨(å¯é€‰)>\" }}` (è‹¥æ— selectorï¼Œåˆ™æå–bodyæ–‡æœ¬)\n"
                    f"    - `browser_click`: ç‚¹å‡»æŒ‡å®šå…ƒç´ ã€‚PARAMETERS: `{{ \"selector\": \"<CSSé€‰æ‹©å™¨>\" }}`\n"
                    f"    (æ›´å¤šæ“ä½œå¦‚ browser_fill_form, browser_extract_links ç­‰è¯·å‚è€ƒå·¥å…·æ–‡æ¡£ï¼Œå¹¶ç¡®ä¿ PARAMETERS æ ¼å¼æ­£ç¡®)"
                )
                tool_descriptions.append(browser_desc)
            elif tool_name == 'python_executor':
                python_desc = (
                    f"- python_executor: ç”¨äºæ‰§è¡ŒPythonä»£ç ã€‚ä¸»è¦ ACTION:\n"
                    f"    - `python_execute`: æ‰§è¡ŒPythonä»£ç ã€‚PARAMETERS: `{{ \"code\": \"<Pythonä»£ç å­—ç¬¦ä¸²>\" }}`"
                )
                tool_descriptions.append(python_desc)
            else:
                tool_descriptions.append(f"- {tool_name}")
        tools_desc = "\n".join(tool_descriptions)
        
        browser_context_str = ""
        if browser_context:
            bc = browser_context # shortcut
            # Ensuring consistent indentation for the f-string block
            browser_context_str = (
                f"\n\nå½“å‰æµè§ˆå™¨çŠ¶æ€:\n"
                f"- å½“å‰URL: {bc.get('current_url', 'N/A')}\n"
                f"- é¡µé¢æ ‡é¢˜: {bc.get('current_page_title', 'N/A')}\n"
                f"- æœ€è¿‘å¯¼èˆªå†å²:\n  {bc.get('recent_navigation_summary', 'æ— å¯¼èˆªå†å²').replace(chr(10), chr(10) + '  ')}\n" # Indent multi-line summary
                f"- ä¸Šæ¬¡æå–æ–‡æœ¬ç‰‡æ®µ: {bc.get('last_text_snippet', 'æ— ')}\n"
                f"- å½“å‰é¡µé¢é“¾æ¥æ‘˜è¦: {bc.get('links_on_page_summary', 'æ— ')}"
            )

        previous_steps_str = ""
        if previous_steps:
            previous_steps_str = "\n\nä¹‹å‰çš„æ‰§è¡Œæ­¥éª¤:\n"
            for i, step in enumerate(previous_steps[-3:], 1):  # åªæ˜¾ç¤ºæœ€è¿‘3æ­¥
                action_str = step.get('action', step.get('action_type', 'unknown_action'))
                observation_str = str(step.get('observation', ''))[:200]
                previous_steps_str += f"  {i}. Action: {action_str}, Observation: {observation_str}...\n"

        # The f-string for prompt_template starts here.
        # All lines of the f-string content should be at least at this indentation level or further indented.
        logger.debug("Applying strict tool usage rules from AGENT_IMPROVEMENT_PLAN.md")
        prompt_template = f"""ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½æ¨ç†åŠ©æ‰‹ï¼Œéœ€è¦é€æ­¥è§£å†³ç”¨æˆ·çš„ä»»åŠ¡ã€‚
ä½ çš„ç›®æ ‡æ˜¯å‡†ç¡®ã€é«˜æ•ˆåœ°å®Œæˆä»»åŠ¡ï¼Œå¹¶æ¸…æ™°åœ°å±•ç¤ºä½ çš„å†³ç­–è¿‡ç¨‹ã€‚

ä»»åŠ¡æè¿°: {task_description}

å¯ç”¨å·¥å…·:
{tools_desc}
{browser_context_str}
{previous_steps_str}
è¯·åˆ†æå½“å‰æƒ…å†µï¼ˆåŒ…æ‹¬ä»»åŠ¡æè¿°ã€å¯ç”¨å·¥å…·ã€æµè§ˆå™¨çŠ¶æ€å’Œä¹‹å‰çš„æ­¥éª¤ï¼‰ï¼Œè¾“å‡ºä½ çš„æ€è€ƒè¿‡ç¨‹å’Œä¸‹ä¸€æ­¥è¡ŒåŠ¨ã€‚æ ¼å¼å¦‚ä¸‹:

THINKING:
[åœ¨è¿™é‡Œè¯¦ç»†æè¿°ä½ çš„æ€è€ƒè¿‡ç¨‹ã€‚åˆ†æä»»åŠ¡éœ€æ±‚ï¼Œå›é¡¾ä¹‹å‰çš„æ­¥éª¤å’Œè§‚å¯Ÿç»“æœï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œè¯„ä¼°å½“å‰çŠ¶æ€ï¼Œå¹¶è§£é‡Šä½ ä¸ºä»€ä¹ˆé€‰æ‹©ä¸‹ä¸€æ­¥çš„è¡ŒåŠ¨å’Œå·¥å…·ã€‚å¦‚æœä¹‹å‰çš„æ­¥éª¤å¤±è´¥ï¼Œè¯·åˆ†æå¤±è´¥åŸå› å¹¶è¯´æ˜ä½ å°†å¦‚ä½•è°ƒæ•´ç­–ç•¥ã€‚]

ACTION: [é€‰æ‹©ä¸€ä¸ªè¡ŒåŠ¨ç±»å‹ã€‚å¯ç”¨è¡ŒåŠ¨åŒ…æ‹¬: browser_navigate, browser_click, browser_get_text, python_execute, python_analyze, python_visualize, complete_task, error]

TOOL: [å¦‚æœä½ é€‰æ‹©çš„ACTIONéœ€è¦å·¥å…·ï¼Œè¯·æŒ‡å®šä½¿ç”¨çš„å…·ä½“å·¥å…·åç§°ï¼Œä¾‹å¦‚ï¼šbrowser, python_executorã€‚å¦‚æœACTIONæ˜¯ complete_task æˆ– errorï¼Œåˆ™TOOLåº”ä¸º None æˆ–ç•™ç©ºã€‚]

PARAMETERS:
[æä¾›ä¸€ä¸ªJSONå¯¹è±¡æ ¼å¼çš„å·¥å…·å‚æ•°ã€‚ä¸¥æ ¼éµå®ˆä»¥ä¸‹è§„åˆ™ï¼š
1.  **å¯¹äº `browser_navigate` ACTION**:
    -   `PARAMETERS` å¿…é¡»æ˜¯ `{{ \"url\": \"<å®Œæ•´çš„ã€æœ‰æ•ˆçš„HTTPæˆ–HTTPS URL>\" }}` çš„æ ¼å¼ã€‚
    -   ç¤ºä¾‹: `{{ \"url\": \"https://www.google.com\" }}`
2.  **å¯¹äº `browser_click` ACTION**:
    -   `PARAMETERS` å¿…é¡»æ˜¯ `{{ \"selector\": \"<CSSé€‰æ‹©å™¨>\" }}` çš„æ ¼å¼ã€‚
    -   ç¤ºä¾‹: `{{ \"selector\": \"button#submit\" }}`
3.  **å¯¹äº `browser_get_text` ACTION**:
    -   `PARAMETERS` å¯ä»¥æ˜¯ `{{ \"selector\": \"<CSSé€‰æ‹©å™¨>\" }}` (æå–ç‰¹å®šå…ƒç´ æ–‡æœ¬) æˆ– `{{}}` (æå–æ•´ä¸ªbodyæ–‡æœ¬)ã€‚
    -   ç¤ºä¾‹: `{{ \"selector\": \"div.article-content\" }}` æˆ– `{{}}`
4.  **å¯¹äº `python_execute` ACTION**:
    -   `PARAMETERS` å¿…é¡»æ˜¯ `{{ \"code\": \"<Pythonä»£ç å­—ç¬¦ä¸²>\" }}`ã€‚
5.  **å¯¹äºå…¶ä»– ACTION**: è¯·æ ¹æ®å·¥å…·çš„å…·ä½“éœ€æ±‚æä¾›å‚æ•°ã€‚
6.  **å¦‚æœACTIONæ˜¯ `complete_task` æˆ– `error`**: `PARAMETERS` åº”ä¸º `{{}}`ã€‚
7.  **ç»å¯¹ç¦æ­¢ä½¿ç”¨ `{{\"raw\": ...}}` ä½œä¸º `PARAMETERS` çš„ä¸»è¦ç»“æ„ã€‚æ‰€æœ‰å‚æ•°éƒ½åº”è¯¥æœ‰æ˜ç¡®çš„é”®åã€‚**
8.  åœ¨ç”Ÿæˆå‚æ•°å‰ï¼Œè¯·åœ¨THINKINGä¸­ç¡®è®¤æ‰€æœ‰å¿…éœ€çš„å‚æ•°å€¼ï¼ˆå°¤å…¶æ˜¯URLï¼‰å·²ç»ä»ä»»åŠ¡æè¿°ã€ä¹‹å‰çš„æ­¥éª¤æˆ–ä½ çš„åˆ†æä¸­è·å–ã€‚å¦‚æœç¼ºå°‘å…³é”®å‚æ•°ï¼Œä½ çš„ACTIONåº”è¯¥æ˜¯errorï¼Œå¹¶åœ¨THINKINGä¸­è¯´æ˜åŸå› ã€‚
]

CONFIDENCE: [æä¾›ä¸€ä¸ª0.0åˆ°1.0ä¹‹é—´çš„å°æ•°ï¼Œè¡¨ç¤ºä½ å¯¹å½“å‰å†³ç­–èƒ½å¤ŸæˆåŠŸæ¨è¿›ä»»åŠ¡çš„ä¿¡å¿ƒã€‚]

è¯·ç¡®ä¿ä½ çš„è¾“å‡ºä¸¥æ ¼éµå¾ªä¸Šè¿°æ ¼å¼çš„æ¯ä¸€éƒ¨åˆ†ã€‚
"""
        return prompt_template # This return must be at the same indentation level as the start of the method body.
    
    def _build_enhanced_reasoning_prompt(self, task_description: str, available_tools: List[str],
                                        tool_descriptions: str, previous_steps: List[Dict] = None,
                                        execution_context: Optional[Dict[str, Any]] = None) -> str:
        """ä¸ºå¢å¼ºæ¨ç†æ„å»ºè¯¦ç»†çš„æç¤º"""

        # System-level instruction
        prompt_parts = [
            "You are a highly intelligent AI agent with dynamic tool capabilities.",
            "You can analyze task requirements and proactively search for new tools when needed.",
            "You MUST respond with a single, valid JSON object and nothing else.",
        ]
        
        # 1. ä»»åŠ¡å®šä¹‰
        prompt_parts.extend([
            "\n## Overall Task",
            "Your main goal is: " + task_description,
        ])

        # 2. å¯ç”¨å·¥å…· - ç‰¹åˆ«å¼ºè°ƒMCPæœç´¢å·¥å…·
        prompt_parts.extend([
            "\n## Available Tools",
            "You have the following tools. Choose the most appropriate one for your next action:",
            tool_descriptions,
            "\n**Special Note about MCP Search Tool:**",
            "- Use 'mcp-search-tool' with action 'analyze_tool_needs' to check if current tools are sufficient",
            "- Use 'mcp-search-tool' with action 'search_and_install_tools' to find and install new tools when needed",
            "- This allows you to expand your capabilities dynamically based on task requirements"
        ])

        # 3. å½“å‰ä¸Šä¸‹æ–‡
        if execution_context and execution_context.get("browser_state"):
            browser_state = execution_context["browser_state"]
            context_str = (
                f"- Current URL: {browser_state.get('url')}\n"
                f"- Page Title: {browser_state.get('title')}\n"
                f"- Page Content Summary: {browser_state.get('content_summary')}"
            )
            prompt_parts.extend([
                "\n## Current Situation",
                "This is your current state. Use this to decide your next step.",
                context_str
            ])
            
        # 4. å†å²è®°å½•
        if previous_steps:
            # Format history to be more concise and clear
            history_lines = []
            
            # åˆ†æå†å²æ­¥éª¤ï¼Œæ£€æµ‹å¾ªç¯å’Œæ¨èè¡ŒåŠ¨
            analyze_tool_needs_count = 0
            search_and_install_count = 0
            last_recommended_action = None
            
            for s in previous_steps:
                # ç»Ÿè®¡MCPå·¥å…·çš„ä½¿ç”¨æƒ…å†µ
                if s.get('tool_id') == 'mcp-search-tool':
                    if s.get('action') == 'analyze_tool_needs':
                        analyze_tool_needs_count += 1
                    elif s.get('action') == 'search_and_install_tools':
                        search_and_install_count += 1
                    
                    # ä»è§‚å¯Ÿä¸­æå–æ¨èè¡ŒåŠ¨
                    observation = s.get('observation', '')
                    if 'search_for_new_tools' in observation:
                        last_recommended_action = 'search_for_new_tools'
                
                tool_call_str = f"Tool call: {s.get('tool_id', 'N/A')}.{s.get('action', 'N/A')}({s.get('parameters', {})})"
                observation_str = f"Observation: {s.get('observation', 'No observation.')}"
                
                # ç‰¹åˆ«æ ‡æ³¨MCPå·¥å…·çš„ä½¿ç”¨ç»“æœ
                if s.get('tool_id') == 'mcp-search-tool':
                    if 'success' in str(s.get('observation', '')).lower():
                        observation_str += " âœ… (MCP tool operation completed)"
                        # è§£ææ¨èè¡ŒåŠ¨
                        if 'recommended_action' in observation_str and 'search_for_new_tools' in observation_str:
                            observation_str += " ğŸ” **RECOMMENDS: search_for_new_tools**"
                    else:
                        observation_str += " âš ï¸ (MCP tool operation had issues)"
                
                history_lines.append(f"### Step {s['step_id']}\n- Thought: {s['thinking']}\n- {tool_call_str}\n- {observation_str}")
            
            # æ·»åŠ å¾ªç¯æ£€æµ‹è­¦å‘Š
            if analyze_tool_needs_count >= 3:
                history_lines.append("\nâš ï¸ **CRITICAL LOOP DETECTION**: You have called 'analyze_tool_needs' 3+ times! You MUST proceed to 'search_and_install_tools' immediately!")
            
            if last_recommended_action == 'search_for_new_tools' and search_and_install_count == 0:
                history_lines.append("\nğŸ” **IMPORTANT**: Previous analysis recommended 'search_for_new_tools'. You MUST use 'search_and_install_tools' action next!")
            
            history_str = "\n".join(history_lines)
            prompt_parts.extend([
                "\n## History of Actions",
                "These are the steps you have already taken:",
                history_str
            ])

        # 5. å†³ç­–æŒ‡å¯¼
        prompt_parts.extend([
            "\n## Decision Making Guidelines",
            "Before choosing your next action, consider:",
            "1. **Task Analysis**: What specific capabilities does this task require?",
            "2. **Tool Assessment**: Do current tools provide all needed functionality?",
            "3. **Gap Identification**: If tools are insufficient, what specific new tools are needed?",
            "4. **Strategic Choice**: Should you analyze tool needs first, search for tools, or proceed with existing tools?",
            "5. **History Review**: What have I already done? Am I repeating actions unnecessarily?",
            "",
            "**CRITICAL LOOP PREVENTION RULES:**",
            "- NEVER call 'analyze_tool_needs' more than 2 times for the same task",
            "- If previous step returned 'recommended_action': 'search_for_new_tools', you MUST use 'search_and_install_tools' next",
            "- If you've already analyzed and confirmed tool gaps, move directly to installation",
            "",
            "**When to use MCP Search Tool:**",
            "- If task requires capabilities not available in current tools (e.g., PDF generation, database access, image processing)",
            "- If previous attempts failed due to missing functionality (not configuration issues)",
            "- If you need to expand your toolset to handle complex or specialized tasks",
            "",
            "**When to use existing tools:**",
            "- If current tools can accomplish the task through proper usage or combination",
            "- If the issue is with parameters or approach, not missing functionality",
            "- If the task can be decomposed into steps using available tools"
        ])

        # 6. æŒ‡ä»¤ä¸è¾“å‡ºæ ¼å¼
        prompt_parts.extend([
            "\n## Step-by-Step Reasoning Process",
            "You MUST think through this systematically following these steps:",
            "",
            "**Step 1: Task Analysis**",
            "- What is the core task I need to accomplish?", 
            "- What specific capabilities does this task require?",
            "- Break down the task into key requirements (e.g., image generation, data processing, web interaction)",
            "",
            "**Step 2: Current Tool Assessment**", 
            "- Review each available tool and its capabilities",
            "- Can current tools handle all aspects of this task?",
            "- Identify specific capabilities that are missing",
            "",
            "**Step 3: Gap Analysis**",
            "- Are there clear gaps between task requirements and available tools?",
            "- Specifically for image generation tasks: Do I have image creation/generation tools?",
            "- For data processing: Do I have sufficient analysis tools?",
            "- For specialized tasks: Do I have domain-specific tools?",
            "",
            "**Step 4: MCP Search Tool Logic Flow**",
            "If tool gaps exist, follow this exact sequence:",
            "- FIRST: Use 'mcp-search-tool' with 'analyze_tool_needs' to assess requirements",
            "- THEN: If analysis confirms gaps, use 'mcp-search-tool' with 'search_and_install_tools'",
            "- FINALLY: After installation, proceed with the new tools",
            "",
            "**Step 5: Action Decision**",
            "- If you've already done analysis and confirmed gaps: Use 'search_and_install_tools'",
            "- If you haven't analyzed yet: Use 'analyze_tool_needs' first",
            "- If no gaps: Proceed with existing tools",
            "- Choose the most logical next step in the sequence",
            "",
            "## Your Response Format",
            "Your response MUST be a single, valid JSON object with detailed step-by-step reasoning:",
            '```json\n'
            '{\n'
            '  "thinking": "DETAILED STEP-BY-STEP ANALYSIS:\\n\\nStep 1 - Task Analysis:\\n[Analyze what this task requires]\\n\\nStep 2 - Tool Assessment:\\n[Review current tools and their capabilities]\\n\\nStep 3 - Gap Analysis:\\n[Identify missing capabilities]\\n\\nStep 4 - Action Decision:\\n[Explain chosen action with reasoning]",\n'
            '  "confidence": 0.0-1.0,\n'
            '  "tool_id": "REQUIRED: exact tool ID (e.g., \'mcp-search-tool\', \'python-executor-mcp-server\')",\n'
            '  "action": "REQUIRED: specific action name (e.g., \'analyze_tool_needs\', \'python_execute\')",\n'
            '  "parameters": {\n'
            '    "task_description": "copy the original task description exactly",\n'
            '    "current_available_tools": "list of current tools for MCP operations",\n'
            '    "reason": "why searching for new tools",\n'
            '    "code": "Python code to execute",\n'
            '    "url": "URL to navigate to"\n'
            '  }\n'
            '}\n'
            '```',
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",
            "CONDITION 1: Never analyzed before + task needs new tools â†’ use 'analyze_tool_needs'",
            "CONDITION 2: Already analyzed + got 'search_for_new_tools' recommendation â†’ use 'search_and_install_tools' IMMEDIATELY",
            "CONDITION 3: Analysis shows sufficient tools â†’ proceed with existing tools",
            "CONDITION 4: Called 'analyze_tool_needs' 2+ times â†’ MUST use 'search_and_install_tools' to break loop",
            "CONDITION 5: New tools successfully installed â†’ proceed with task using new tools",
            "",
            "**DECISION TREE:**",
            "1. Check history: Have I called 'analyze_tool_needs' before?",
            "   - YES: Did previous analysis recommend 'search_for_new_tools'?",
            "     - YES â†’ Use 'search_and_install_tools' (DO NOT analyze again)",
            "     - NO â†’ Proceed with existing tools",
            "   - NO: Does task need capabilities I don't have?",
            "     - YES â†’ Use 'analyze_tool_needs' (FIRST TIME ONLY)",
            "     - NO â†’ Proceed with existing tools",
            "",
            "**Critical Guidelines:**",
            "- For image generation tasks WITHOUT image tools: Use 'mcp-search-tool' with 'analyze_tool_needs' FIRST",
            "- After analysis confirms gaps: Use 'mcp-search-tool' with 'search_and_install_tools' to find new tools",
            "- If you see 'recommended_action': 'search_for_new_tools' in previous results: Use 'search_and_install_tools'",
            "- Always include detailed step-by-step reasoning in the 'thinking' field",
            "- The tool_id and action fields are mandatory and must be exact matches",
            "",
            "**CRITICAL SEQUENCE LOGIC:**",